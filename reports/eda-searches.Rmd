---
title: "EDA buscas"
author: "Whendell Feijó Magalhães"
output:
    html_document:
        code_folding: hide
---

<style>
body{text-align: justify}
</style>


O objeto principal da análise são as buscas e a navegação depois da busca. Criamos esses dados a partir dos dados originais da wikimedia em `/data/search_data.csv`. 

Aqui, exploramos esses dados. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(lubridate)
library(scales)
theme_set(theme_bw())

knitr::opts_chunk$set(tidy = FALSE,
                      echo = FALSE,
                      fig.width = 8,
                      fig.height = 6,
                      fig.align = "center")
```

```{r ETL}
buscas = read_csv(here::here("data/search_data.csv"))

Mode <- function(x) {
     ux <- unique(x)
     ux[which.max(tabulate(match(x, ux)))]
}
 
```
## 1. What is our daily overall clickthrough rate? How does it vary between the groups?

```{r}

### Preprocessando os dados para criar uma nova coluna contendo unicamente o dia em que a sessão foi iniciada e removendo valores extremos que não fazem sentido com o contexto do problema (first_click > 500) 

buscas <- mutate(buscas, day = round_date(buscas$session_start_date, "day")) %>%
    group_by(session_id) %>%
    mutate(day = min(day)) %>% 
    ungroup() %>% 
    filter(is.na(first_click) | first_click <= 500)

sessoes <- buscas %>%
    group_by(session_id, group, day) %>% 
    summarise(num_clicks = any(num_clicks > 0)) %>% 
    group_by(day, group)

# buscas %>%
#     group_by(session_id) %>% 
#     mutate(num_clicks = max(num_clicks)) %>% 
#     ungroup() %>% 
#     group_by(day) %>%
#     count(clicks_bigger_0 = num_clicks > 0) %>%
#     mutate(total = sum(n)) %>% 
#     filter(clicks_bigger_0 == TRUE) %>% 
#     ungroup()

# buscas %>%
#     group_by(session_id,day) %>%
#     summarise(session_total_clicks = sum(num_clicks)) %>% 
#     ggplot(aes(x = day, y = session_total_clicks)) +
#     geom_point()
# 
# buscas %>%
#     group_by(session_id,day) %>%
#     summarise(session_total_clicks = sum(num_clicks), group = Mode(group)) %>% 
#     ggplot(aes(x = day, y = session_total_clicks, color = group)) +
#     geom_point()
```

## Let session length be approximately the time between the first event and the last event in a session. Choose a variable from the dataset and describe its relationship to session length. Visualize the relationship.

```{r}
# buscas %>%
#     group_by(session_id) %>% 
#     summarise(search_index = max(search_index), session_length = max(session_length)) %>% 
#     ggplot(aes(x = session_length, y = search_index)) +
#     geom_point(alpha = .55)

options(scipen = 999)

```

